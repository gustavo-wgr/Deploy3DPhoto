<!DOCTYPE html>
<html lang="en">
<head>
    <title>Immersive Autochromes</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
        }

        #VRButton {
            z-index: 99999 !important;
        }

        .button-container {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column; /* Change to 'row' for horizontal layout */
            gap: 10px; /* Space between buttons */
        }

        .button {
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .model-type-button {
            padding: 10px 15px;
            background-color: rgba(0, 150, 255, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 5px;
        }

        .model-type-button.active {
            background-color: rgba(0, 100, 200, 0.9);
        }

        .model-info {
            color: white;
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 3px;
        }
        
        .loading {
            background-color: rgba(255, 165, 0, 0.8) !important;
        }
        
        .error {
            background-color: rgba(255, 0, 0, 0.8) !important;
        }
        
        .vr-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none; /* Hidden by default, shown in VR */
        }
        
        .vr-controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .vr-controls ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .vr-controls li {
            margin: 5px 0;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            margin-top: 0;
            color: #333;
            font-size: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .modal-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .web-button {
            background-color: #4CAF50;
            color: white;
        }

        .web-button:hover {
            background-color: #45a049;
        }

        .local-button {
            background-color: #2196F3;
            color: white;
        }

        .local-button:hover {
            background-color: #1976D2;
        }

        .folder-selection {
            margin-top: 15px;
        }

        .folder-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .folder-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .folder-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .file-count {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .file-input-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-input-container.dragover {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .drag-drop-area {
            border: 2px dashed #2196F3;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f0f8ff;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .drag-drop-area.dragover {
            border-color: #1976D2;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }

        .drag-drop-area p {
            margin: 0;
            color: #666;
            font-size: 16px;
        }

        .drag-drop-area .icon {
            font-size: 48px;
            color: #2196F3;
            margin-bottom: 10px;
        }

        .path-input-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .path-input-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .path-input-group {
            margin-bottom: 10px;
        }

        .path-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .path-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            font-family: monospace;
        }

        .path-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .path-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .file-input-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .file-input-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            color: #666;
        }

        .file-input-tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        .file-input-tab-content {
            display: none;
        }

        .file-input-tab-content.active {
            display: block;
        }

        /* VR-friendly improvements */
        @media (max-width: 768px), (pointer: coarse) {
            .modal-content {
                width: 90%;
                margin: 2% auto;
                padding: 20px;
            }
            
            .file-input-tab {
                padding: 15px 20px;
                font-size: 16px;
                min-height: 44px; /* Touch-friendly minimum size */
            }
            
            .drag-drop-area {
                padding: 40px 20px;
                min-height: 200px;
            }
            
            .path-input {
                padding: 12px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .modal-button {
                padding: 15px 30px;
                font-size: 18px;
                min-height: 44px;
            }
            
            .start-button {
                padding: 15px 30px;
                font-size: 18px;
                min-height: 44px;
            }
        }

        /* VR-specific styles */
        .vr-mode .modal-content {
            font-size: 18px;
            line-height: 1.6;
        }
        
        .vr-mode .file-input-tab {
            font-size: 18px;
            padding: 20px 25px;
        }
        
        .vr-mode .drag-drop-area {
            font-size: 18px;
            padding: 50px 30px;
        }
        
        .vr-mode .path-input {
            font-size: 18px;
            padding: 15px;
        }

        .file-list {
            margin-top: 15px;
            text-align: left;
        }

        .file-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #e8f5e8;
            border-radius: 3px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .model-type-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f5f5f5;
            max-height: 200px;
            overflow-y: auto;
        }

        .model-type-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .model-type-files {
            margin-top: 10px;
        }

        .start-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }

        .start-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }
    </style>
    <script type="importmap">
        {
           "imports": {
					"three": "./build/three.module.js",
					"three/addons/": "./jsm/"
				}
        }

    </script>
</head>
<body>
<div id="container"></div>

<!-- Modal for choosing between web and local models -->
<div id="modelChoiceModal" class="modal">
    <div class="modal-content">
        <h2>Choose Model Source</h2>
        <p>Select how you want to load 3D models:</p>
        <div class="modal-buttons">
            <button class="modal-button web-button" onclick="chooseWebModels()">Load from Web</button>
            <button class="modal-button local-button" onclick="chooseLocalModels()">Upload Local Files</button>
        </div>
        
        <div id="fileInputContainer" class="file-input-container">
            <div class="file-input-tabs">
                <button class="file-input-tab active" onclick="switchFileInputTab('folder')">Folder Selection</button>
                <button class="file-input-tab" onclick="switchFileInputTab('dragdrop')">Drag & Drop</button>
                <button class="file-input-tab" onclick="switchFileInputTab('path')">File Selection</button>
            </div>
            
            <!-- Folder Selection Tab -->
            <div id="folderTab" class="file-input-tab-content active">
                <p>Select folders containing GLB/GLTF files for each depth model type:</p>
                
                <div class="folder-selection">
                    <div class="folder-input-group">
                        <label for="depthAnythingFolder">DepthAnything Models Folder:</label>
                        <input type="file" id="depthAnythingFolder" class="folder-input" webkitdirectory directory multiple onchange="handleFolderSelect(event, 'depthAnything')">
                        <div id="depthAnythingFileCount" class="file-count"></div>
                    </div>
                    
                    <div class="folder-input-group">
                        <label for="midasFolder">MiDaS Models Folder:</label>
                        <input type="file" id="midasFolder" class="folder-input" webkitdirectory directory multiple onchange="handleFolderSelect(event, 'midas')">
                        <div id="midasFileCount" class="file-count"></div>
                    </div>
                    
                    <div class="folder-input-group">
                        <label for="lotusFolder">Lotus Models Folder:</label>
                        <input type="file" id="lotusFolder" class="folder-input" webkitdirectory directory multiple onchange="handleFolderSelect(event, 'lotus')">
                        <div id="lotusFileCount" class="file-count"></div>
                    </div>
                </div>
            </div>
            
            <!-- Drag & Drop Tab -->
            <div id="dragdropTab" class="file-input-tab-content">
                <div class="drag-drop-area" id="dragDropArea">
                    <div class="icon">üìÅ</div>
                    <p><strong>Drag and drop your GLB/GLTF files here</strong></p>
                    <p>or click to browse files</p>
                    <input type="file" id="dragDropInput" multiple accept=".glb,.gltf" style="display: none;">
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    <strong>Note:</strong> Files will be automatically categorized based on their names. 
                    Files containing "depth", "anything", or "dpt" will be assigned to DepthAnything models.
                    Files containing "midas" will be assigned to MiDaS models.
                    Files containing "lotus" will be assigned to Lotus models.
                    Other files will be assigned to DepthAnything by default.
                </p>
            </div>
            
            <!-- Path Input Tab -->
            <div id="pathTab" class="file-input-tab-content">
                <div class="path-input-section">
                    <h4>Select Model Files</h4>
                    <p style="margin-bottom: 15px; color: #666;">Select individual GLB/GLTF files for each model type:</p>
                    
                    <div class="path-input-group">
                        <label for="depthAnythingPath">DepthAnything Models:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="depthAnythingPath" class="path-input" placeholder="Select GLB/GLTF files for DepthAnything models" style="flex: 1;" readonly>
                            <button type="button" onclick="browseDirectory('depthAnything')" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">Select Files</button>
                        </div>
                        <div class="path-help">Click "Select Files" to choose GLB/GLTF files for DepthAnything models</div>
                    </div>
                    
                    <div class="path-input-group">
                        <label for="midasPath">MiDaS Models:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="midasPath" class="path-input" placeholder="Select GLB/GLTF files for MiDaS models" style="flex: 1;" readonly>
                            <button type="button" onclick="browseDirectory('midas')" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">Select Files</button>
                        </div>
                        <div class="path-help">Click "Select Files" to choose GLB/GLTF files for MiDaS models</div>
                    </div>
                    
                    <div class="path-input-group">
                        <label for="lotusPath">Lotus Models:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="lotusPath" class="path-input" placeholder="Select GLB/GLTF files for Lotus models" style="flex: 1;" readonly>
                            <button type="button" onclick="browseDirectory('lotus')" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">Select Files</button>
                        </div>
                        <div class="path-help">Click "Select Files" to choose GLB/GLTF files for Lotus models</div>
                    </div>
                    

                </div>
            </div>
            
            <div id="modelTypeSections" class="model-type-section" style="display: none;">
                <h4>Selected files by model type:</h4>
                <div id="depthAnythingSection" class="model-type-files">
                    <strong>DepthAnything Models:</strong>
                    <div id="depthAnythingFiles"></div>
                </div>
                <div id="midasSection" class="model-type-files">
                    <strong>MiDaS Models:</strong>
                    <div id="midasFiles"></div>
                </div>
                <div id="lotusSection" class="model-type-files">
                    <strong>Lotus Models:</strong>
                    <div id="lotusFiles"></div>
                </div>
            </div>
            
            <button id="startButton" class="start-button" onclick="startWithLocalModels()" disabled>Start with Selected Models</button>
        </div>
    </div>
</div>

<div class="button-container">
    <button id="modelTypeButton" class="model-type-button hidden">Change Depth Model</button>
    <div id="modelInfo" class="model-info hidden">DepthAnything - Model 122</div>
    <!--  <button id="prevButton" class="button">Previous</button>-->
    <button id="nextButton" class="button hidden">Next</button>
</div>

<div class="vr-controls" id="vrControls">
    <h3>VR Controls</h3>
    <ul>
        <li><strong>Right Thumbpad Left/Right:</strong> Previous/Next Model</li>
        <li><strong>Left Thumbpad Up:</strong> Switch Depth Model Type</li>
        <li><strong>Left Trigger:</strong> Move Model Down</li>
        <li><strong>Left Grip:</strong> Move Model Up</li>
        <li><strong>Right Trigger:</strong> Move Model Left</li>
        <li><strong>Right Grip:</strong> Move Model Right</li>
    </ul>
</div>

<script type="module">
    import * as THREE from 'three';
    import {VRButton} from 'three/addons/webxr/VRButton.js';
    // import { XR_BUTTONS } from 'gamepad-wrapper';
    import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';

    const scene = new THREE.Scene();
    const data = JSON.parse('{"Height": 745, "Width": 960, "hFov": 0.9272952180016122, "vFov": 0.7412849108138079}');
    const maxFov = 90;

    const user = new THREE.Group();
    const camera = new THREE.PerspectiveCamera(maxFov, window.innerWidth / window.innerHeight, 0.1, 100);
    user.add(camera);
    scene.add(user);

    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x808080); // Change background to black
    renderer.xr.enabled = true;

    const vrButton = VRButton.createButton(renderer);
    document.body.appendChild(vrButton);
    document.getElementById('container').appendChild(renderer.domElement);

    let cameraZOffset = 0;
    let cameraZMaxOffset = 0.025;
    let direction = 1;
    let nonVrCameraPosition = new THREE.Vector3();
    let nonVrCameraRotation = new THREE.Euler();
    let matrixCam = new THREE.Matrix4();
    nonVrCameraPosition.copy(camera.position);
    nonVrCameraRotation.copy(camera.rotation);
    matrixCam.copy(camera.matrix);

    const loader = new GLTFLoader();
    
    // Define model arrays for both types
    const depthAnythingModels = [
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000122_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000123_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000140_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000110_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000345_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000412_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000422_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000457_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000490_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000491_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000152_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000154_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000161_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000321_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000089_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000196_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000443_access.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/anythingv2_models/cacdoha_000116_access.glb'
    ];

    const midasModels = [
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000122_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000123_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000140_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000110_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000345_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000412_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000422_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000457_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000490_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000491_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000152_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000154_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000161_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000321_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000089_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000196_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000443_access_crop.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/midas_models/cacdoha_000116_access_crop.glb'
    ];

    const lotusModels = [
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/122.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/123.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000140_access-17550003610000.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/110.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000345_access-17550003610008.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000412_access-17550003610009.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000422_access-17550003610010.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000457_access-17550003610012.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000490_access-17550003610013.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000491_access-17550003610014.glb',

        //'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000149_access-17550003610001.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000152_access-17550003610002.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000154_access-17550003610003.glb',
        //'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000156_access-17550003610004.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000161_access-17550003610005.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000321_access-17550003610007.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/89.glb',

        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000196_access-17550003610006.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/cacdoha_000443_access-17550003610011.glb',
        'https://huggingface.co/gust-t/deploy3d/resolve/main/lotus_models/116.glb'
    ];

    let currentModelType = 'depthAnything'; // 'depthAnything', 'midas', or 'lotus'
    let models = [...depthAnythingModels]; // Start with DepthAnything models
    let currentModelIndex = 0;
    let currentModel = null; // Keep a reference to the current model
    let isLocalMode = false; // Track if we're in local file mode
    let localFiles = []; // Array to store local file URLs
    let localFilesByType = {
        depthAnything: [],
        midas: [],
        lotus: []
    }; // Organize local files by model type
    
    // Memory management for large models
    let loadedModels = new Map(); // Cache for loaded models
    let modelAccessOrder = []; // Track access order for LRU cache
    const MAX_CACHED_MODELS = 3; // Limit cached models to prevent memory issues
    let isLoading = false; // Prevent multiple simultaneous loads

    // Global functions for modal interaction
    window.chooseWebModels = function() {
        document.getElementById('modelChoiceModal').style.display = 'none';
        isLocalMode = false;
        initializeWebMode();
    };

    window.chooseLocalModels = function() {
        document.getElementById('fileInputContainer').style.display = 'block';
        document.querySelector('.modal-buttons').style.display = 'none';
        document.getElementById('modelTypeSections').style.display = 'block';
        // Initialize empty arrays for each model type
        localFilesByType = { depthAnything: [], midas: [], lotus: [] };
    };

    // Tab switching function
    window.switchFileInputTab = function(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.file-input-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.file-input-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // Add active class to selected tab
        event.target.classList.add('active');
    };

    // Drag and drop functionality
    window.setupDragAndDrop = function() {
        const dragDropArea = document.getElementById('dragDropArea');
        const dragDropInput = document.getElementById('dragDropInput');
        
        // Click to browse files
        dragDropArea.addEventListener('click', () => {
            dragDropInput.click();
        });
        
        // Drag and drop events
        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.classList.add('dragover');
        });
        
        dragDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
        });
        
        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleDragDropFiles(files);
        });
        
        // File input change
        dragDropInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleDragDropFiles(files);
        });
    };

    // Handle files dropped or selected via drag and drop
    window.handleDragDropFiles = function(files) {
        // Clear previous files
        localFilesByType = { depthAnything: [], midas: [], lotus: [] };
        
        // Categorize files based on their names
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileName = file.name.toLowerCase();
            
            // Check if it's a valid GLB/GLTF file
            if (file.type === 'model/gltf-binary' || file.type === 'model/gltf+json' || 
                fileName.endsWith('.glb') || fileName.endsWith('.gltf')) {
                
                const fileUrl = URL.createObjectURL(file);
                
                // Categorize based on filename
                if (fileName.includes('midas')) {
                    localFilesByType.midas.push(fileUrl);
                } else if (fileName.includes('lotus')) {
                    localFilesByType.lotus.push(fileUrl);
                } else if (fileName.includes('depth') || fileName.includes('anything') || fileName.includes('dpt')) {
                    localFilesByType.depthAnything.push(fileUrl);
                } else {
                    // Default to DepthAnything
                    localFilesByType.depthAnything.push(fileUrl);
                }
            }
        }
        
        // Update the file count displays
        updateFileCounts();
        
        // Show the model type sections
        document.getElementById('modelTypeSections').style.display = 'block';
        
        // Update the file lists
        updateFileLists();
        
        // Enable/disable start button
        const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
        document.getElementById('startButton').disabled = totalFiles === 0;
        
        if (totalFiles > 0) {
            alert(`Successfully loaded ${totalFiles} files:\n- DepthAnything: ${localFilesByType.depthAnything.length}\n- MiDaS: ${localFilesByType.midas.length}\n- Lotus: ${localFilesByType.lotus.length}`);
        }
    };

    // Path input functionality
    window.loadFromPaths = function() {
        const depthAnythingPath = document.getElementById('depthAnythingPath').value.trim();
        const midasPath = document.getElementById('midasPath').value.trim();
        const lotusPath = document.getElementById('lotusPath').value.trim();
        
        if (!depthAnythingPath && !midasPath && !lotusPath) {
            alert('Please enter at least one folder path.');
            return;
        }
        
        // Try to use File System Access API if available
        if ('showDirectoryPicker' in window) {
            loadFromPathsWithFileSystemAPI();
        } else {
            alert('Path-based loading requires a modern browser with File System Access API support. Please use the Drag & Drop or Folder Selection options instead.');
        }
    };

    // Load files using File System Access API
    async function loadFromPathsWithFileSystemAPI() {
        try {
            // Clear previous files
            localFilesByType = { depthAnything: [], midas: [], lotus: [] };
            
            // Show directory picker for each model type
            const depthAnythingPath = document.getElementById('depthAnythingPath').value.trim();
            const midasPath = document.getElementById('midasPath').value.trim();
            const lotusPath = document.getElementById('lotusPath').value.trim();
            
            if (depthAnythingPath) {
                await loadFilesFromDirectory('depthAnything', 'DepthAnything Models');
            }
            if (midasPath) {
                await loadFilesFromDirectory('midas', 'MiDaS Models');
            }
            if (lotusPath) {
                await loadFilesFromDirectory('lotus', 'Lotus Models');
            }
            
            // Update UI
            updateFileCounts();
            updateFileLists();
            document.getElementById('modelTypeSections').style.display = 'block';
            
            const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
            document.getElementById('startButton').disabled = totalFiles === 0;
            
            if (totalFiles > 0) {
                alert(`Successfully loaded ${totalFiles} files:\n- DepthAnything: ${localFilesByType.depthAnything.length}\n- MiDaS: ${localFilesByType.midas.length}\n- Lotus: ${localFilesByType.lotus.length}`);
            }
            
        } catch (error) {
            console.error('Error loading files from paths:', error);
            alert('Error loading files. Please try using the Drag & Drop option instead.');
        }
    }

    // Load files from a directory using File System Access API
    async function loadFilesFromDirectory(modelType, displayName) {
        try {
            const dirHandle = await window.showDirectoryPicker({
                title: `Select ${displayName} Folder`
            });
            
            const files = [];
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const fileName = entry.name.toLowerCase();
                    if (fileName.endsWith('.glb') || fileName.endsWith('.gltf')) {
                        const file = await entry.getFile();
                        const fileUrl = URL.createObjectURL(file);
                        localFilesByType[modelType].push(fileUrl);
                        files.push(entry.name);
                    }
                }
            }
            
            console.log(`Loaded ${files.length} files from ${displayName} directory`);
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('User cancelled directory selection');
            } else {
                throw error;
            }
        }
    }

    // Browse files function for individual model types
    window.browseDirectory = async function(modelType) {
        const displayNames = {
            depthAnything: 'DepthAnything Models',
            midas: 'MiDaS Models',
            lotus: 'Lotus Models'
        };
        
        // Try File System Access API first (works on Quest 2)
        if ('showOpenFilePicker' in window) {
            try {
                const fileHandles = await window.showOpenFilePicker({
                    title: `Select ${displayNames[modelType]} Files`,
                    multiple: true,
                    types: [
                        {
                            description: '3D Model Files',
                            accept: {
                                'model/gltf-binary': ['.glb'],
                                'model/gltf+json': ['.gltf']
                            }
                        }
                    ]
                });
                
                // Clear previous files for this model type
                localFilesByType[modelType] = [];
                
                const selectedFiles = [];
                for (const fileHandle of fileHandles) {
                    const file = await fileHandle.getFile();
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.glb') || fileName.endsWith('.gltf')) {
                        const fileUrl = URL.createObjectURL(file);
                        localFilesByType[modelType].push(fileUrl);
                        selectedFiles.push(file.name);
                    }
                }
                
                // Update the path input field with selected file names
                const pathInput = document.getElementById(modelType + 'Path');
                if (pathInput) {
                    if (selectedFiles.length === 1) {
                        pathInput.value = selectedFiles[0];
                    } else if (selectedFiles.length > 1) {
                        pathInput.value = `${selectedFiles.length} files selected`;
                    } else {
                        pathInput.value = 'No valid files selected';
                    }
                }
                
                // Update UI
                updateFileCounts();
                updateFileLists();
                document.getElementById('modelTypeSections').style.display = 'block';
                
                const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
                document.getElementById('startButton').disabled = totalFiles === 0;
                
                console.log(`Loaded ${selectedFiles.length} files for ${displayNames[modelType]}`);
                
                if (selectedFiles.length > 0) {
                    alert(`Successfully loaded ${selectedFiles.length} files for ${displayNames[modelType]}`);
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('User cancelled file selection');
                } else {
                    console.error('Error with File System Access API:', error);
                    // Fallback to standard file input
                    fallbackToStandardFileInput(modelType, displayNames[modelType]);
                }
            }
        } else {
            // Fallback to standard file input for browsers without File System Access API
            fallbackToStandardFileInput(modelType, displayNames[modelType]);
        }
    };
    
    // Fallback function using standard file input
    function fallbackToStandardFileInput(modelType, displayName) {
        try {
            // Create a file input element for selecting GLB files
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.glb,.gltf';
            fileInput.multiple = true;
            fileInput.style.display = 'none';
            
            // Handle file selection
            fileInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    // Clear previous files for this model type
                    localFilesByType[modelType] = [];
                    
                    const selectedFiles = [];
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileName = file.name.toLowerCase();
                        
                        if (fileName.endsWith('.glb') || fileName.endsWith('.gltf')) {
                            const fileUrl = URL.createObjectURL(file);
                            localFilesByType[modelType].push(fileUrl);
                            selectedFiles.push(file.name);
                        }
                    }
                    
                    // Update the path input field with selected file names
                    const pathInput = document.getElementById(modelType + 'Path');
                    if (pathInput) {
                        if (selectedFiles.length === 1) {
                            pathInput.value = selectedFiles[0];
                        } else if (selectedFiles.length > 1) {
                            pathInput.value = `${selectedFiles.length} files selected`;
                        } else {
                            pathInput.value = 'No valid files selected';
                        }
                    }
                    
                    // Update UI
                    updateFileCounts();
                    updateFileLists();
                    document.getElementById('modelTypeSections').style.display = 'block';
                    
                    const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
                    document.getElementById('startButton').disabled = totalFiles === 0;
                    
                    console.log(`Loaded ${selectedFiles.length} files for ${displayName}`);
                    
                    if (selectedFiles.length > 0) {
                        alert(`Successfully loaded ${selectedFiles.length} files for ${displayName}`);
                    }
                }
                
                // Clean up the file input
                document.body.removeChild(fileInput);
            };
            
            // Add file input to DOM and trigger click
            document.body.appendChild(fileInput);
            fileInput.click();
            
        } catch (error) {
            console.error('Error with fallback file input:', error);
            alert('Error browsing files. Please try again.');
        }
    }

    // Helper function to update file counts
    function updateFileCounts() {
        document.getElementById('depthAnythingFileCount').textContent = 
            `${localFilesByType.depthAnything.length} files selected`;
        document.getElementById('midasFileCount').textContent = 
            `${localFilesByType.midas.length} files selected`;
        document.getElementById('lotusFileCount').textContent = 
            `${localFilesByType.lotus.length} files selected`;
    }

    // Helper function to update file lists
    function updateFileLists() {
        // Update DepthAnything files
        const depthAnythingFiles = document.getElementById('depthAnythingFiles');
        depthAnythingFiles.innerHTML = '';
        localFilesByType.depthAnything.forEach((fileUrl, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = `File ${index + 1}`;
            depthAnythingFiles.appendChild(fileItem);
        });
        
        // Update MiDaS files
        const midasFiles = document.getElementById('midasFiles');
        midasFiles.innerHTML = '';
        localFilesByType.midas.forEach((fileUrl, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = `File ${index + 1}`;
            midasFiles.appendChild(fileItem);
        });
        
        // Update Lotus files
        const lotusFiles = document.getElementById('lotusFiles');
        lotusFiles.innerHTML = '';
        localFilesByType.lotus.forEach((fileUrl, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = `File ${index + 1}`;
            lotusFiles.appendChild(fileItem);
        });
    }

    window.handleFolderSelect = function(event, modelType) {
        const files = event.target.files;
        const fileCount = document.getElementById(`${modelType}FileCount`);
        const filesList = document.getElementById(`${modelType}Files`);
        const startButton = document.getElementById('startButton');
        
        // Clear previous files for this model type
        localFilesByType[modelType] = [];
        filesList.innerHTML = '';
        
        let validFiles = [];
        
        if (files.length > 0) {
            // First, collect all valid files
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type === 'model/gltf-binary' || file.type === 'model/gltf+json' || 
                    file.name.toLowerCase().endsWith('.glb') || file.name.toLowerCase().endsWith('.gltf')) {
                    validFiles.push(file);
                }
            }
            
            // Sort files by name
            validFiles.sort((a, b) => a.name.localeCompare(b.name));
            
            // Now add sorted files to the array
            validFiles.forEach(file => {
                const fileUrl = URL.createObjectURL(file);
                localFilesByType[modelType].push(fileUrl);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileName = document.createElement('span');
                fileName.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                
                fileItem.appendChild(fileName);
                filesList.appendChild(fileItem);
            });
            
            fileCount.textContent = `${validFiles.length} valid files selected`;
        } else {
            fileCount.textContent = 'No files selected';
        }
        
        // Check if we have any files in any model type
        const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
        startButton.disabled = totalFiles === 0;
    };

    window.startWithLocalModels = function() {
        const totalFiles = localFilesByType.depthAnything.length + localFilesByType.midas.length + localFilesByType.lotus.length;
        if (totalFiles > 0) {
            document.getElementById('modelChoiceModal').style.display = 'none';
            isLocalMode = true;
            initializeLocalMode();
        }
    };

    function initializeWebMode() {
        // Show all UI elements for web mode
        document.getElementById('modelTypeButton').classList.remove('hidden');
        document.getElementById('modelInfo').classList.remove('hidden');
        document.getElementById('nextButton').classList.remove('hidden');
        
        // Initialize with web models
        models = [...depthAnythingModels];
        currentModelType = 'depthAnything';
        currentModelIndex = 0;
        
        // Start loading the first model
        loadModel(currentModelIndex);
    }

    function initializeLocalMode() {
        // Show the model type button for local mode since we now have categorized files
        document.getElementById('modelTypeButton').classList.remove('hidden');
        document.getElementById('modelInfo').classList.remove('hidden');
        document.getElementById('nextButton').classList.remove('hidden');
        
        // Use local files as models, starting with DepthAnything
        models = localFilesByType.depthAnything;
        currentModelType = 'depthAnything';
        currentModelIndex = 0;
        
        // Start loading the first model
        loadModel(currentModelIndex);
    }

    function switchModelType() {
        // Store the current index to maintain position across model types
        const currentIndex = currentModelIndex;
        const oldModelType = currentModelType;

        // Remove current model
        if (currentModel) {
            scene.remove(currentModel);
        }

        // Switch model type
        if (currentModelType === 'depthAnything') {
            currentModelType = 'midas';
            if (isLocalMode) {
                models = localFilesByType.midas;
            } else {
                models = [...midasModels];
            }
        } else if (currentModelType === 'midas') {
            currentModelType = 'lotus';
            if (isLocalMode) {
                models = localFilesByType.lotus;
            } else {
                models = [...lotusModels];
            }
        } else {
            currentModelType = 'depthAnything';
            if (isLocalMode) {
                models = localFilesByType.depthAnything;
            } else {
                models = [...depthAnythingModels];
            }
        }

        // Use the same index position in the new array
        currentModelIndex = currentIndex;
        
        // Ensure index is within bounds
        if (currentModelIndex >= models.length) {
            currentModelIndex = 0;
        }

        console.log(`Switching model type: ${oldModelType} ‚Üí ${currentModelType}`);
        console.log(`Models available: ${oldModelType} (${models.length} files)`);
        console.log(`Index adjustment: ${currentIndex + 1} ‚Üí ${currentModelIndex + 1} (${models.length} total)`);

        loadModel(currentModelIndex);
    }

    function changeModel(direction) {
        if (isLoading) return; // Prevent loading while another load is in progress
        
        // Remove the current model from the scene if it exists
        if (currentModel) {
            scene.remove(currentModel);
        }

        const oldIndex = currentModelIndex;
        currentModelIndex += direction;
        if (currentModelIndex < 0) currentModelIndex = models.length - 1;
        if (currentModelIndex >= models.length) currentModelIndex = 0;

        console.log(`Switching model: ${oldIndex + 1} ‚Üí ${currentModelIndex + 1} (${direction > 0 ? 'next' : 'previous'})`);
        console.log(`Model type: ${currentModelType}, Total models: ${models.length}`);

        // Clear cache when moving to a new model index (only for web mode)
        if (!isLocalMode) {
            clearModelCache();
            console.log(`Cache cleared - moving to new model index: ${currentModelIndex}`);
        }

        // Load the new model and keep a reference to it
        loadModel(currentModelIndex);
        
        // Log cache status after switching (only for web mode)
        if (!isLocalMode) {
            setTimeout(() => getCacheInfo(), 1000);
        }
    }

    function loadModel(index) {
        if (isLoading) return;
        isLoading = true;
        
        const modelPath = models[index];
        const filename = isLocalMode ? `Local File ${index + 1}` : modelPath.split('/').pop();
        const modelKey = `${currentModelType}_${index}`;
        
        console.log(`Loading ${currentModelType} model at index ${index} (${filename})`);
        console.log(`Model file: ${filename}`);
        console.log(`Array position: ${index + 1} of ${models.length} total models`);
        console.log(`Model type queue: ${currentModelType} (${models.length} models available)`);
        
        // Check if model is already cached (only for web mode)
        if (!isLocalMode && loadedModels.has(modelKey)) {
            console.log(`Using cached model: ${modelKey}`);
            const cachedModel = loadedModels.get(modelKey);
            currentModel = cachedModel.clone();
            scene.add(currentModel);
            updateModelInfo(index);
            isLoading = false;
            
            // Update access order (move to end = most recently used)
            updateModelAccessOrder(modelKey);
            return;
        }
        
        // Show loading indicator
        const modelInfo = document.getElementById('modelInfo');
        modelInfo.textContent = `Loading ${isLocalMode ? 'local' : currentModelType} model...`;
        modelInfo.className = 'model-info loading';
        
        loader.load(modelPath, function (gltf) {
            gltf.scene.rotation.x = Math.PI;
            const zoomScale = 4.2;

            gltf.scene.traverse(function (node) {
                if (node.isMesh) {
                    node.scale.set(zoomScale, zoomScale, 1);
                    node.material = new THREE.MeshBasicMaterial({
                        vertexColors: true,
                        transparent: false,
                        opacity: 1.0
                    });
                    node.frustumCulled = true;
                }
            });

            // Cache the loaded model (only for web mode)
            if (!isLocalMode) {
                loadedModels.set(modelKey, gltf.scene.clone());
                
                // Update access order
                updateModelAccessOrder(modelKey);
                
                // Manage cache size using LRU (Least Recently Used)
                manageCacheSize();
            }

            // Set current model reference and add to scene
            currentModel = gltf.scene;
            scene.add(currentModel);
            
            updateModelInfo(index);
            console.log(`‚úì Successfully loaded ${currentModelType} model at index ${index}`);
            console.log(`‚úì Model loaded: ${filename} (${index + 1}/${models.length})`);
            isLoading = false;
            
            // Preload other model types at same index in background (only for web mode)
            if (!isLocalMode) {
                setTimeout(preloadOtherModelTypes, 1000);
            }
        }, 
        // Progress callback
        function (progress) {
            const percent = Math.round((progress.loaded / progress.total) * 100);
            const modelInfo = document.getElementById('modelInfo');
            modelInfo.textContent = `Loading ${isLocalMode ? 'local' : currentModelType} model... ${percent}%`;
            modelInfo.className = 'model-info loading';
        },
        function (error) {
            console.error(`Error loading ${currentModelType} model at index ${index}:`, error);
            console.error(`Failed to load: ${filename} (${index + 1}/${models.length})`);
            const modelInfo = document.getElementById('modelInfo');
            modelInfo.textContent = `Error loading model`;
            modelInfo.className = 'model-info error';
            isLoading = false;
        });
    }
    
    function updateModelInfo(index) {
        let modelTypeDisplay;
        if (isLocalMode) {
            // For local mode, show the actual depth model type name
            if (currentModelType === 'depthAnything') {
                modelTypeDisplay = 'DepthAnything';
            } else if (currentModelType === 'midas') {
                modelTypeDisplay = 'MiDaS';
            } else {
                modelTypeDisplay = 'Lotus';
            }
        } else if (currentModelType === 'depthAnything') {
            modelTypeDisplay = 'DepthAnything';
        } else if (currentModelType === 'midas') {
            modelTypeDisplay = 'MiDaS';
        } else {
            modelTypeDisplay = 'Lotus';
        }
        const modelInfo = document.getElementById('modelInfo');
        modelInfo.textContent = `${modelTypeDisplay} - Index ${index + 1}`;
        modelInfo.className = 'model-info';
    }
    
    // LRU Cache Management Functions
    function updateModelAccessOrder(modelKey) {
        // Remove from current position if exists
        const index = modelAccessOrder.indexOf(modelKey);
        if (index > -1) {
            modelAccessOrder.splice(index, 1);
        }
        // Add to end (most recently used)
        modelAccessOrder.push(modelKey);
    }
    
    function manageCacheSize() {
        // Remove least recently used models if cache is too large
        while (loadedModels.size > MAX_CACHED_MODELS) {
            const leastRecentlyUsed = modelAccessOrder.shift(); // Remove oldest
            if (leastRecentlyUsed) {
                loadedModels.delete(leastRecentlyUsed);
                console.log(`Removed least recently used model: ${leastRecentlyUsed}`);
            }
        }
    }
    
    function getCacheInfo() {
        console.log(`Cache status: ${loadedModels.size}/${MAX_CACHED_MODELS} models`);
        console.log('Cached models:', Array.from(loadedModels.keys()));
        console.log('Access order (oldest to newest):', modelAccessOrder);
    }
    
    // Memory management functions
    function clearModelCache() {
        loadedModels.clear();
        modelAccessOrder = [];
        console.log('Model cache cleared');
    }
    
    function getMemoryInfo() {
        if (performance.memory) {
            const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
            const total = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
            const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
            console.log(`Memory: ${used}MB used / ${total}MB total / ${limit}MB limit`);
            return { used, total, limit };
        }
        return null;
    }
    
    // Monitor memory usage
    setInterval(() => {
        const memoryInfo = getMemoryInfo();
        if (memoryInfo && memoryInfo.used > memoryInfo.limit * 0.8) {
            console.warn('High memory usage detected, clearing cache...');
            clearModelCache();
        }
    }, 10000); // Check every 10 seconds
    
    // Preload same index from other model types in background (only for web mode)
    function preloadOtherModelTypes() {
        if (isLocalMode) {
            // For local mode, preload other model types if they have files (but don't cache)
            const currentIndex = currentModelIndex;
            const otherModelTypes = [];
            
            if (currentModelType === 'depthAnything') {
                if (localFilesByType.midas.length > 0) otherModelTypes.push('midas');
                if (localFilesByType.lotus.length > 0) otherModelTypes.push('lotus');
            } else if (currentModelType === 'midas') {
                if (localFilesByType.depthAnything.length > 0) otherModelTypes.push('depthAnything');
                if (localFilesByType.lotus.length > 0) otherModelTypes.push('lotus');
            } else if (currentModelType === 'lotus') {
                if (localFilesByType.depthAnything.length > 0) otherModelTypes.push('depthAnything');
                if (localFilesByType.midas.length > 0) otherModelTypes.push('midas');
            }
            
            // Preload each other model type at the same index (without caching)
            otherModelTypes.forEach(modelType => {
                const modelKey = `${modelType}_${currentIndex}`;
                
                if (!isLoading && currentIndex < localFilesByType[modelType].length) {
                    console.log(`Preloading local ${modelType} model at index ${currentIndex}: ${modelKey}`);
                    
                    const modelPath = localFilesByType[modelType][currentIndex];
                    
                    loader.load(modelPath, function (gltf) {
                        gltf.scene.rotation.x = Math.PI;
                        const zoomScale = 4.2;
                        
                        gltf.scene.traverse(function (node) {
                            if (node.isMesh) {
                                node.scale.set(zoomScale, zoomScale, 1);
                                node.material = new THREE.MeshBasicMaterial({
                                    vertexColors: true,
                                    transparent: false,
                                    opacity: 1.0
                                });
                                node.frustumCulled = true;
                            }
                        });
                        
                        // Don't cache local models
                        console.log(`‚úì Preloaded local ${modelType} model: ${modelKey}`);
                    });
                }
            });
            return;
        }
        
        const currentIndex = currentModelIndex;
        
        // Get the other model types
        const otherModelTypes = [];
        if (currentModelType === 'depthAnything') {
            otherModelTypes.push('midas', 'lotus');
        } else if (currentModelType === 'midas') {
            otherModelTypes.push('depthAnything', 'lotus');
        } else if (currentModelType === 'lotus') {
            otherModelTypes.push('depthAnything', 'midas');
        }
        
        // Preload each other model type at the same index
        otherModelTypes.forEach(modelType => {
            const modelKey = `${modelType}_${currentIndex}`;
            
            if (!loadedModels.has(modelKey) && !isLoading) {
                console.log(`Preloading ${modelType} model at index ${currentIndex}: ${modelKey}`);
                
                // Get the correct model array and path
                let modelArray, modelPath;
                if (modelType === 'depthAnything') {
                    modelArray = depthAnythingModels;
                } else if (modelType === 'midas') {
                    modelArray = midasModels;
                } else if (modelType === 'lotus') {
                    modelArray = lotusModels;
                }
                
                // Check if index is valid for this model type
                if (currentIndex < modelArray.length) {
                    modelPath = modelArray[currentIndex];
                    
                    loader.load(modelPath, function (gltf) {
                        gltf.scene.rotation.x = Math.PI;
                        const zoomScale = 4.2;
                        
                        gltf.scene.traverse(function (node) {
                            if (node.isMesh) {
                                node.scale.set(zoomScale, zoomScale, 1);
                                node.material = new THREE.MeshBasicMaterial({
                                    vertexColors: true,
                                    transparent: false,
                                    opacity: 1.0
                                });
                                node.frustumCulled = true;
                            }
                        });
                        
                        loadedModels.set(modelKey, gltf.scene.clone());
                        console.log(`‚úì Preloaded ${modelType} model: ${modelKey}`);
                        
                        // Update access order for preloaded model
                        updateModelAccessOrder(modelKey);
                        
                        // Manage cache size using LRU
                        manageCacheSize();
                    });
                }
            }
        });
    }

    window.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowRight') {
            changeModel(1); // Next model
        } else if (event.key === 'ArrowLeft') {
            changeModel(-1); // Previous model
        } else if (event.key === ' ') { // Spacebar to switch model type (now works in both modes)
            switchModelType();
        } else if (event.key === 'c' || event.key === 'C') { // C key to check cache status
            getCacheInfo();
        }
    });

    let thumbpadRightPressed = false; // Track thumbpad press state
    let thumbpadLeftPressed = false; // Track thumbpad press state
    let leftTriggerPressed = false; // Track left trigger press state
    let leftGripPressed = false; // Track left grip press state
    let rightTriggerPressed = false; // Track right trigger press state
    let rightGripPressed = false; // Track right grip press state
    let leftThumbpadPressed = false; // Track left thumbpad press state for model type switching
    function handleGamepadInput() {
        const session = renderer.xr.getSession();
        if (session) { // Only if we are in a WebXR session
            for (const sourceXR of session.inputSources) {
                if (!sourceXR.gamepad) continue;
                
                // Check for right controller
                if (
                    sourceXR &&
                    sourceXR.gamepad &&
                    sourceXR.handedness === 'right' // Check for the right handedness
                ) {
                    const axes = sourceXR.gamepad.axes; // Get thumbpad axes
                    const thumbpadX = axes[2]; // Adjust this index based on your specific controller
                    // Change model based on thumbpad movement
                    if (thumbpadX >= 0.5 && !thumbpadRightPressed) { // Adjust thres/midas if needed
                        thumbpadRightPressed = true; // Set the state to pressed
                        changeModel(1); // Move to the next model
                    } else if (thumbpadX < 0.5) {
                        thumbpadRightPressed = false; // Reset the state when released
                    }
                    if (thumbpadX <= -0.5 && !thumbpadLeftPressed) { // Adjust thres/midas if needed
                        thumbpadLeftPressed = true; // Set the state to pressed
                        changeModel(-1); // Move to the next model
                    }
                    else if(thumbpadX > -0.5){
                        thumbpadLeftPressed = false
                    }
                }
                
                // Check for left controller
                if (
                    sourceXR &&
                    sourceXR.gamepad &&
                    sourceXR.handedness === 'left' // Check for the left handedness
                ) {
                    const buttons = sourceXR.gamepad.buttons;
                    const axes = sourceXR.gamepad.axes;
                    const triggerButton = buttons[0]; // Usually the trigger is button 0
                    const gripButton = buttons[1]; // Usually the grip is button 1
                    const thumbpadY = axes[3]; // Left thumbpad Y axis
                    
                    // Left trigger - Move model down
                    if (triggerButton && triggerButton.pressed && !leftTriggerPressed) {
                        leftTriggerPressed = true;
                        // Move the current model down on Y axis
                        if (currentModel) {
                            currentModel.position.y -= 0.1; // Adjust this value to control movement speed
                        }
                    } else if (triggerButton && !triggerButton.pressed) {
                        leftTriggerPressed = false;
                    }
                    
                    // Left grip - Move model up
                    if (gripButton && gripButton.pressed && !leftGripPressed) {
                        leftGripPressed = true;
                        // Move the current model up on Y axis
                        if (currentModel) {
                            currentModel.position.y += 0.1; // Adjust this value to control movement speed
                        }
                    } else if (gripButton && !gripButton.pressed) {
                        leftGripPressed = false;
                    }
                    
                    // Left thumbpad up/down - Switch depth model type (works in both modes now)
                    if (thumbpadY >= 0.5 && !leftThumbpadPressed) {
                        leftThumbpadPressed = true;
                        switchModelType(); // Switch between DepthAnything/MiDaS/Lotus
                        console.log('VR: Switched depth model type');
                    } else if (thumbpadY < 0.5) {
                        leftThumbpadPressed = false;
                    }
                }
                
                // Check for right controller buttons (grip and trigger)
                if (
                    sourceXR &&
                    sourceXR.gamepad &&
                    sourceXR.handedness === 'right' // Check for the right handedness
                ) {
                    const buttons = sourceXR.gamepad.buttons;
                    const triggerButton = buttons[0]; // Usually the trigger is button 0
                    const gripButton = buttons[1]; // Usually the grip is button 1
                    
                    // Right trigger - Move model sideways left
                    if (triggerButton && triggerButton.pressed && !rightTriggerPressed) {
                        rightTriggerPressed = true;
                        // Move the current model left on X axis
                        if (currentModel) {
                            currentModel.position.x -= 0.1; // Adjust this value to control movement speed
                        }
                    } else if (triggerButton && !triggerButton.pressed) {
                        rightTriggerPressed = false;
                    }
                    
                    // Right grip - Move model sideways right
                    if (gripButton && gripButton.pressed && !rightGripPressed) {
                        rightGripPressed = true;
                        // Move the current model right on X axis
                        if (currentModel) {
                            currentModel.position.x += 0.1; // Adjust this value to control movement speed
                        }
                    } else if (gripButton && !gripButton.pressed) {
                        rightGripPressed = false;
                    }
                }
            }
        }
    }
    function animate() {
        renderer.setAnimationLoop(function () {
            if (renderer.xr.isPresenting) {
                user.position.set(0, -1.6, 0);
                handleGamepadInput();
                // Show VR controls
                document.getElementById('vrControls').style.display = 'block';
                // camera.updateProjectionMatrix();
            } else {
                camera.position.copy(nonVrCameraRotation);
                camera.rotation.copy(nonVrCameraRotation);
                camera.matrix.copy(matrixCam);
                user.position.set(0, 0, 0);
                cameraZOffset += direction * 0.00005;
                if (cameraZOffset >= cameraZMaxOffset || cameraZOffset <= 0) {
                    direction *= -1;
                }
                camera.position.z = -cameraZOffset;
                // Hide VR controls
                document.getElementById('vrControls').style.display = 'none';
            }
            camera.updateProjectionMatrix();
            renderer.render(scene, camera);
        });
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // document.getElementById('prevButton').addEventListener('click', () => {
    //   changeModel(-1); // Previous model
    // });

    document.getElementById('nextButton').addEventListener('click', () => {
        changeModel(1); // Next model
    });

    document.getElementById('modelTypeButton').addEventListener('click', () => {
        switchModelType();
    });

    // Show the modal when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('modelChoiceModal').style.display = 'block';
        // Initialize drag and drop functionality
        setupDragAndDrop();
        
        // Detect VR mode and apply appropriate styles
        if (navigator.userAgent.includes('Quest') || navigator.userAgent.includes('Oculus') || 
            window.innerWidth > 2000 || window.innerHeight > 2000) {
            document.body.classList.add('vr-mode');
        }
        
        // Also detect when entering VR session
        renderer.xr.addEventListener('sessionstart', function() {
            document.body.classList.add('vr-mode');
        });
        
        renderer.xr.addEventListener('sessionend', function() {
            document.body.classList.remove('vr-mode');
        });
    });

    animate();
</script>
</body>
</html>